<div
  id="palette-panel-root"
  class="flex flex-col h-full p-2 space-y-2"
>
  <div id="palette-panel-actions" class="flex items-center gap-1 flex-wrap">
    <button
      type="button"
      id="palette-panel-create-new"
      class="flex items-center gap-1 px-2 py-1 text-xs rounded-sm bg-blue-500 hover:bg-blue-600 text-white"
      (click)="onCreateNew()"
      [attr.aria-keyshortcuts]="hotkeys.getBinding('palette.createNew')"
      [paTooltip]="'palette.createNewTooltip' | transloco"
    >
      <ng-icon id="palette-panel-create-new-icon" name="heroiconsPlusMini" class="w-3 h-3"></ng-icon>
      <span id="palette-panel-create-new-label">{{ "palette.createNew" | transloco }}</span>
    </button>
    <button
      type="button"
      id="palette-panel-from-selection"
      class="flex items-center gap-1 px-2 py-1 text-xs rounded-sm bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600 text-neutral-800 dark:text-neutral-200"
      (click)="onCreateFromSelection()"
      [attr.aria-keyshortcuts]="hotkeys.getBinding('palette.createFromSelection')"
      [paTooltip]="'palette.fromSelectionTooltip' | transloco"
    >
      <ng-icon id="palette-panel-from-selection-icon" name="heroiconsSquare2StackMini" class="w-3 h-3"></ng-icon>
      <span id="palette-panel-from-selection-label">{{ "palette.fromSelection" | transloco }}</span>
    </button>
    <button
      type="button"
      id="palette-panel-from-layer"
      class="flex items-center gap-1 px-2 py-1 text-xs rounded-sm bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600 text-neutral-800 dark:text-neutral-200"
      (click)="onCreateFromLayer()"
      [attr.aria-keyshortcuts]="hotkeys.getBinding('palette.createFromLayer')"
      [paTooltip]="'palette.fromLayerTooltip' | transloco"
    >
      <ng-icon id="palette-panel-from-layer-icon" name="heroiconsRectangleStackMini" class="w-3 h-3"></ng-icon>
      <span id="palette-panel-from-layer-label">{{ "palette.fromLayer" | transloco }}</span>
    </button>
  </div>

  <div id="palette-panel-list-section" class="flex-1 overflow-auto">
    @if (paletteService.palettes().length === 0) {
      <div
        id="palette-panel-empty"
        class="flex flex-col items-center justify-center h-full text-center text-neutral-500 dark:text-neutral-400 p-4"
      >
        <ng-icon id="palette-panel-empty-icon" name="heroiconsSwatchMini" class="w-8 h-8 mb-2 opacity-50"></ng-icon>
        <p id="palette-panel-empty-text" class="text-sm">{{ "palette.emptyState" | transloco }}</p>
      </div>
    } @else {
      <div id="palette-panel-list" class="space-y-1">
        @for (palette of paletteService.palettes(); track palette.id) {
          <div
            id="palette-item-{{ palette.id }}"
            class="rounded-sm border cursor-pointer transition-colors"
            [ngClass]="{
              'border-blue-500 bg-blue-50 dark:bg-blue-900/20': selectedPaletteId() === palette.id,
              'border-neutral-200 dark:border-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-800': selectedPaletteId() !== palette.id
            }"
            (click)="selectPalette(palette.id)"
          >
            <div
              id="palette-item-header-{{ palette.id }}"
              class="flex items-center justify-between px-2 py-1"
            >
              @if (editingPaletteId() === palette.id) {
                <input
                  type="text"
                  id="palette-item-name-input-{{ palette.id }}"
                  class="flex-1 px-1 py-0.5 text-xs bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-600 rounded-sm"
                  [(ngModel)]="editingPaletteName"
                  (blur)="onRenameBlur()"
                  (keydown)="onRenameKeydown($event)"
                  (click)="$event.stopPropagation()"
                  autofocus
                />
              } @else {
                <span
                  id="palette-item-name-{{ palette.id }}"
                  class="text-xs font-medium text-neutral-800 dark:text-neutral-200 truncate flex-1"
                  (dblclick)="startRename(palette, $event)"
                >
                  {{ palette.name }}
                </span>
              }
              <div id="palette-item-actions-{{ palette.id }}" class="flex items-center gap-0.5">
                <span
                  id="palette-item-count-{{ palette.id }}"
                  class="text-xs text-neutral-500 dark:text-neutral-400 mr-1"
                >
                  {{ palette.colors.length }}
                </span>
                <button
                  type="button"
                  id="palette-item-rename-{{ palette.id }}"
                  class="p-0.5 rounded-sm hover:bg-neutral-200 dark:hover:bg-neutral-600"
                  (click)="startRename(palette, $event)"
                  [paTooltip]="'palette.rename' | transloco"
                >
                  <ng-icon name="heroiconsPencilMini" class="w-3 h-3"></ng-icon>
                </button>
                <button
                  type="button"
                  id="palette-item-delete-{{ palette.id }}"
                  class="p-0.5 rounded-sm hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400"
                  (click)="onDeletePalette(palette.id, $event)"
                  [paTooltip]="'palette.delete' | transloco"
                >
                  <ng-icon name="heroiconsTrashMini" class="w-3 h-3"></ng-icon>
                </button>
              </div>
            </div>
            @if (palette.colors.length > 0) {
              <div
                id="palette-item-colors-{{ palette.id }}"
                class="flex flex-wrap gap-0.5 px-2 pb-2"
              >
                @for (color of palette.colors.slice(0, 12); track $index; let idx = $index) {
                  <div
                    id="palette-color-swatch-{{ palette.id }}-{{ idx }}"
                    class="w-4 h-4 rounded-sm border border-neutral-300 dark:border-neutral-600"
                    [style.background-color]="color"
                    [title]="color"
                  ></div>
                }
                @if (palette.colors.length > 12) {
                  <span
                    id="palette-colors-more-{{ palette.id }}"
                    class="text-xs text-neutral-500 dark:text-neutral-400 ml-1"
                  >
                    +{{ palette.colors.length - 12 }}
                  </span>
                }
              </div>
            }
          </div>
        }
      </div>
    }
  </div>

  @if (selectedPalette()) {
    <div
      id="palette-panel-detail"
      class="border-t border-neutral-200 dark:border-neutral-700 pt-2"
    >
      <div
        id="palette-detail-header"
        class="flex items-center justify-between mb-2"
      >
        <span
          id="palette-detail-title"
          class="text-xs font-medium text-neutral-800 dark:text-neutral-200"
        >
          {{ selectedPalette()?.name }}
        </span>
        <button
          type="button"
          id="palette-detail-add-color"
          class="flex items-center gap-1 px-1.5 py-0.5 text-xs rounded-sm bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600"
          (click)="showAddColorDialog()"
          [paTooltip]="'palette.addColor' | transloco"
        >
          <ng-icon id="palette-detail-add-color-icon" name="heroiconsPlusMini" class="w-3 h-3"></ng-icon>
          <span id="palette-detail-add-color-label">{{ "palette.addColor" | transloco }}</span>
        </button>
      </div>
      <div
        id="palette-detail-colors"
        class="flex flex-wrap gap-1 max-h-32 overflow-auto"
        role="grid"
        tabindex="0"
        (keydown)="onColorGridKeydown($event)"
        [attr.aria-label]="'palette.colorGrid' | transloco"
      >
        @for (color of selectedPalette()?.colors || []; track $index; let idx = $index) {
          <button
            type="button"
            id="palette-detail-swatch-{{ idx }}"
            role="gridcell"
            class="relative group w-6 h-6 rounded-sm border cursor-pointer focus:ring-2 focus:ring-blue-500 focus:outline-none"
            [class.border-neutral-300]="focusedColorIndex() !== idx"
            [class.dark\:border-neutral-600]="focusedColorIndex() !== idx"
            [class.border-blue-500]="focusedColorIndex() === idx"
            [class.ring-2]="focusedColorIndex() === idx"
            [class.ring-blue-400]="focusedColorIndex() === idx"
            [style.background-color]="color"
            [title]="color"
            [attr.aria-label]="color"
            draggable="true"
            tabindex="-1"
            (click)="onColorClick(color)"
            (focus)="onColorFocus(idx)"
            (dragstart)="onColorDragStart($event, idx)"
            (dragover)="onColorDragOver($event)"
            (drop)="onColorDrop($event, idx)"
          >
            <span
              id="palette-detail-swatch-remove-{{ idx }}"
              class="absolute -top-1 -right-1 w-3 h-3 rounded-full bg-red-500 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center text-xs pointer-events-none"
              aria-hidden="true"
            >
              Ã—
            </span>
          </button>
        }
        @if ((selectedPalette()?.colors?.length || 0) === 0) {
          <span
            id="palette-detail-no-colors"
            class="text-xs text-neutral-500 dark:text-neutral-400"
          >
            {{ "palette.noColors" | transloco }}
          </span>
        }
      </div>
    </div>
  }
</div>

@if (addColorDialogVisible()) {
  <div
    id="palette-add-color-overlay"
    class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    (click)="hideAddColorDialog()"
  >
    <div
      id="palette-add-color-dialog"
      class="bg-white dark:bg-neutral-800 rounded-sm shadow-lg p-4 min-w-64"
      (click)="$event.stopPropagation()"
    >
      <h3
        id="palette-add-color-title"
        class="text-sm font-medium text-neutral-800 dark:text-neutral-200 mb-3"
      >
        {{ "palette.addColor" | transloco }}
      </h3>
      @if (colorPickerState.isPickingColor()) {
        <div
          id="palette-picking-color-hint"
          class="flex items-center gap-2 p-3 mb-4 bg-blue-50 dark:bg-blue-900/20 rounded-sm border border-blue-200 dark:border-blue-800"
        >
          <ng-icon id="palette-picking-icon" name="heroiconsEyeDropperMini" class="w-4 h-4 text-blue-500"></ng-icon>
          <span id="palette-picking-text" class="text-xs text-blue-600 dark:text-blue-400">
            {{ "palette.pickingColor" | transloco }}
          </span>
        </div>
      }
      <div id="palette-add-color-picker" class="flex items-center gap-2 mb-4">
        <input
          type="color"
          id="palette-add-color-input"
          [(ngModel)]="newColorValue"
          class="w-10 h-10 rounded-sm border border-neutral-300 dark:border-neutral-600 cursor-pointer"
        />
        <input
          type="text"
          id="palette-add-color-hex"
          [(ngModel)]="newColorValue"
          class="flex-1 px-2 py-1 text-sm bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-600 rounded-sm font-mono"
        />
        <button
          type="button"
          id="palette-pick-color-btn"
          class="p-2 rounded-sm bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600"
          [class.bg-blue-100]="colorPickerState.isPickingColor()"
          [class.dark\:bg-blue-900\/30]="colorPickerState.isPickingColor()"
          (click)="startPickColor()"
          [paTooltip]="'palette.pickColorFromCanvas' | transloco"
        >
          <ng-icon id="palette-pick-color-icon" name="heroiconsEyeDropperMini" class="w-4 h-4"></ng-icon>
        </button>
      </div>
      <div id="palette-add-color-buttons" class="flex justify-end gap-2">
        <button
          type="button"
          id="palette-add-color-cancel"
          class="px-3 py-1 text-sm rounded-sm bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600"
          (click)="hideAddColorDialog()"
        >
          {{ "palette.cancel" | transloco }}
        </button>
        <button
          type="button"
          id="palette-add-color-confirm"
          class="px-3 py-1 text-sm rounded-sm bg-blue-500 hover:bg-blue-600 text-white"
          (click)="onAddColor()"
        >
          {{ "palette.add" | transloco }}
        </button>
      </div>
    </div>
  </div>
}
