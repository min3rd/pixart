<div id="editor-canvas-root" class="relative h-full w-full">
  <div
    #canvasContainer
    id="editor-canvas-container"
    class="absolute inset-0 p-4 overflow-hidden"
  >
    <div id="editor-canvas-stage" class="relative h-full w-full">
      <div id="editor-canvas-wrap" class="canvas-wrap">
        <div
          #canvasWrapper
          id="editor-canvas-transform"
          class="transform-origin-center"
          [style.transform]="'translate(' + panX() + 'px,' + panY() + 'px)'"
          [style.transform-origin]="'top left'"
        >
          <canvas
            id="editor-canvas-surface"
            #canvasEl
            [attr.width]="documentSvc.canvasWidth()"
            [attr.height]="documentSvc.canvasHeight()"
            [style.cursor]="cursor()"
            class="border border-neutral-300 dark:border-neutral-700 block"
            (pointerdown)="onPointerDown($event)"
            (pointerup)="onPointerUp($event)"
            (pointercancel)="onPointerUp($event)"
            (dblclick)="onDoubleClick($event)"
            (contextmenu)="onCanvasContextMenu($event)"
          ></canvas>
        </div>
      </div>
    </div>
    <canvas
      id="editor-canvas-overlay"
      #overlayCanvasEl
      class="overlay-canvas"
      [style.cursor]="cursor()"
      (pointermove)="onPointerMove($event)"
      (pointerdown)="onPointerDown($event)"
      (pointerup)="onPointerUp($event)"
      (pointercancel)="onPointerUp($event)"
      (pointerleave)="onPointerLeave()"
      (dblclick)="onDoubleClick($event)"
      (contextmenu)="onCanvasContextMenu($event)"
    ></canvas>
  </div>

  <!-- Mouse coordinates -->
  <div
    id="editor-canvas-coordinates"
    class="absolute left-2 top-2 text-xs text-neutral-700 dark:text-neutral-300 bg-neutral-50/80 dark:bg-neutral-900/60 rounded-sm p-1"
  >
    X: <strong>{{ mouseX() ?? "-" }}</strong> Y:
    <strong>{{ mouseY() ?? "-" }}</strong>
  </div>

  <!-- Info panel -->
  @if (infoVisible()) {
    <div
      #canvasInfoPanel
      id="editor-canvas-info-panel"
      class="absolute right-2 top-2 w-56 text-sm bg-white/80 dark:bg-neutral-900/70 backdrop-blur-md rounded-lg shadow-lg border border-neutral-200/60 dark:border-neutral-800/60 overflow-hidden"
    >
      <div id="editor-canvas-info-header" class="flex items-center px-3 py-2">
        <div id="editor-canvas-info-title" class="flex items-center gap-2">
          <ng-icon
            name="bootstrapInfoCircle"
            class="w-5 h-5 text-neutral-700 dark:text-neutral-200"
          ></ng-icon>
          <div
            id="editor-canvas-info-label"
            class="text-sm font-medium text-neutral-800 dark:text-neutral-100"
          >
            {{ "canvas.infoTitle" | transloco }}
          </div>
        </div>
        <div
          id="editor-canvas-info-meta"
          class="ml-auto flex items-center gap-2"
        >
          <div
            id="editor-canvas-info-scale"
            class="text-xs px-2 py-0.5 rounded bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-200"
          >
            {{ scale().toFixed(2) }}x
          </div>
          <button
            type="button"
            id="editor-canvas-info-close"
            class="w-7 h-7 grid place-items-center rounded hover:bg-neutral-100 dark:hover:bg-neutral-800"
            (click)="infoVisible.set(false)"
            aria-label="Close info"
          >
            <ng-icon
              name="featherMinus"
              class="w-4 h-4 text-neutral-700 dark:text-neutral-200"
            ></ng-icon>
          </button>
        </div>
      </div>

      <div
        id="editor-canvas-info-body"
        class="border-t border-neutral-200/50 dark:border-neutral-800/50 px-3 py-3"
      >
        <div
          id="editor-canvas-dimensions"
          class="grid grid-cols-2 gap-2 items-center"
        >
          <label
            id="editor-canvas-width-label"
            class="text-xs text-neutral-600 dark:text-neutral-300"
            >{{ "canvas.width" | transloco }}</label
          >
          <input
            type="number"
            id="editor-canvas-width-input"
            [value]="documentSvc.canvasWidth()"
            (input)="setCanvasWidth($event)"
            class="w-full text-sm rounded-md border border-neutral-200 dark:border-neutral-800 px-2 py-1 bg-white dark:bg-neutral-900 text-neutral-800 dark:text-neutral-100"
            min="1"
            max="4096"
          />

          <label
            id="editor-canvas-height-label"
            class="text-xs text-neutral-600 dark:text-neutral-300"
            >{{ "canvas.height" | transloco }}</label
          >
          <input
            type="number"
            id="editor-canvas-height-input"
            [value]="documentSvc.canvasHeight()"
            (input)="setCanvasHeight($event)"
            class="w-full text-sm rounded-md border border-neutral-200 dark:border-neutral-800 px-2 py-1 bg-white dark:bg-neutral-900 text-neutral-800 dark:text-neutral-100"
            min="1"
            max="4096"
          />
        </div>

        <div
          id="editor-canvas-save-state"
          class="mt-3 text-xs text-neutral-600 dark:text-neutral-300 flex items-center gap-2"
        >
          @if (documentSvc.canvasSaved()) {
            <ng-icon name="check" class="w-4 h-4 text-green-500"></ng-icon>
          } @else {
            <ng-icon name="clock" class="w-4 h-4 text-amber-400"></ng-icon>
          }
          <div>
            {{
              documentSvc.canvasSaved()
                ? ("canvas.saved" | transloco)
                : ("canvas.unsaved" | transloco)
            }}
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Always-visible opener when panel hidden -->
  @if (!infoVisible()) {
    <div id="editor-canvas-info-toggle" class="absolute right-2 top-2">
      <button
        type="button"
        id="editor-canvas-info-open"
        class="w-8 h-8 p-1 bg-neutral-100 dark:bg-neutral-800 rounded-sm shadow-sm"
        (click)="infoVisible.set(true)"
        aria-label="Open info"
      >
        <ng-icon
          name="bootstrapChevronLeft"
          class="w-5 h-5 text-neutral-800 dark:text-neutral-200"
        ></ng-icon>
      </button>
    </div>
  }

  <!-- Bottom-right: Zoom slider + rotation display/reset -->
  <div
    id="editor-canvas-zoom-panel"
    class="absolute right-2 bottom-2 flex items-center gap-3 bg-neutral-50/70 dark:bg-neutral-900/60 rounded-sm p-2 shadow-sm"
  >
    <div id="editor-canvas-zoom-controls" class="flex items-center gap-2">
      <label id="editor-canvas-zoom-label" class="text-xs opacity-80">{{
        "canvas.zoom" | transloco
      }}</label>
      <button
        type="button"
        id="editor-canvas-zoom-decrease"
        class="w-7 h-7 grid place-items-center bg-neutral-100 dark:bg-neutral-800 rounded-sm"
        (click)="decreaseZoom()"
        aria-label="{{ 'canvas.zoomDecrease' | transloco }}"
      >
        <ng-icon name="featherMinus" class="w-4 h-4"></ng-icon>
      </button>
      <input
        type="range"
        id="editor-canvas-zoom-slider"
        [min]="minScale"
        [max]="maxScale"
        step="0.01"
        [value]="scale()"
        (input)="onScaleInput($event)"
        class="w-40"
      />
      <button
        type="button"
        id="editor-canvas-zoom-increase"
        class="w-7 h-7 grid place-items-center bg-neutral-100 dark:bg-neutral-800 rounded-sm"
        (click)="increaseZoom()"
        aria-label="{{ 'canvas.zoomIncrease' | transloco }}"
      >
        <ng-icon name="featherPlus" class="w-4 h-4"></ng-icon>
      </button>
      <div id="editor-canvas-zoom-readout" class="text-xs ml-2 w-14 text-right">
        {{ scale().toFixed(2) }}x
      </div>
    </div>

    <!-- rotation controls removed (feature temporarily disabled) -->
  </div>

  @if (contextMenuVisible()) {
    <div
      id="editor-canvas-context-overlay"
      class="absolute inset-0 z-40"
      (pointerdown)="closeContextMenu()"
    ></div>
    <div
      id="editor-canvas-context-menu"
      class="absolute z-50 min-w-40 rounded-sm border border-neutral-200/70 dark:border-neutral-700/60 bg-neutral-50/90 dark:bg-neutral-900/80 backdrop-blur px-1 py-1 shadow-lg"
      [style.left.px]="contextMenuPosition().x"
      [style.top.px]="contextMenuPosition().y"
    >
      @for (item of contextMenuActions(); track item.id) {
        <button
          #menuButton
          id="editor-canvas-context-action-{{ item.id }}"
          type="button"
          [class]="
            'flex w-full items-center gap-2 rounded-sm px-3 py-2 text-xs text-neutral-700 dark:text-neutral-200 ' +
            (item.disabled
              ? 'opacity-50 cursor-not-allowed'
              : 'hover:bg-neutral-200/70 dark:hover:bg-neutral-800/70')
          "
          [disabled]="item.disabled"
          (click)="
            item.submenu && item.submenu.length > 0
              ? onSubmenuTrigger(item, $event, menuButton)
              : onContextMenuAction(item.id, $event)
          "
          (mouseenter)="
            item.submenu && item.submenu.length > 0
              ? onSubmenuTrigger(item, $event, menuButton)
              : null
          "
          [attr.aria-keyshortcuts]="getShortcutForAction(item.id)"
        >
          <ng-icon
            id="editor-canvas-context-action-icon-{{ item.id }}"
            [name]="item.icon"
            class="h-4 w-4 text-neutral-600 dark:text-neutral-300"
          ></ng-icon>
          <span
            id="editor-canvas-context-action-label-{{ item.id }}"
            class="flex-1 text-left"
          >
            {{ item.labelKey | transloco }}
          </span>
          @if (getShortcutForAction(item.id)) {
            <span
              id="editor-canvas-context-action-shortcut-{{ item.id }}"
              class="ml-2 text-xs opacity-60"
            >
              {{ getShortcutForAction(item.id) }}
            </span>
          }
          @if (item.submenu && item.submenu.length > 0) {
            <ng-icon
              name="heroIconsChevronRightMini"
              class="h-4 w-4 text-neutral-500 dark:text-neutral-400"
            ></ng-icon>
          }
        </button>
      }
    </div>
    @if (submenuVisible()) {
      <div
        id="editor-canvas-context-submenu"
        class="absolute z-50 min-w-32 rounded-sm border border-neutral-200/70 dark:border-neutral-700/60 bg-neutral-50/90 dark:bg-neutral-900/80 backdrop-blur px-1 py-1 shadow-lg"
        [style.left.px]="submenuPosition().x"
        [style.top.px]="submenuPosition().y"
      >
        @for (subitem of submenuActions(); track subitem.id) {
          <button
            id="editor-canvas-context-subaction-{{ subitem.id }}"
            type="button"
            class="flex w-full items-center gap-2 rounded-sm px-3 py-2 text-xs text-neutral-700 dark:text-neutral-200 hover:bg-neutral-200/70 dark:hover:bg-neutral-800/70"
            (click)="onContextMenuAction(subitem.id, $event)"
            [attr.aria-keyshortcuts]="getShortcutForAction(subitem.id)"
          >
            <ng-icon
              id="editor-canvas-context-subaction-icon-{{ subitem.id }}"
              [name]="subitem.icon"
              class="h-3 w-3 text-neutral-600 dark:text-neutral-300"
            ></ng-icon>
            <span
              id="editor-canvas-context-subaction-label-{{ subitem.id }}"
              class="flex-1"
            >
              {{ subitem.labelKey | transloco }}
            </span>
            @if (getShortcutForAction(subitem.id)) {
              <span
                id="editor-canvas-context-subaction-shortcut-{{ subitem.id }}"
                class="ml-2 text-xs opacity-60"
              >
                {{ getShortcutForAction(subitem.id) }}
              </span>
            }
          </button>
        }
      </div>
    }
  }

  @if (inputDialogVisible()) {
    <div
      id="editor-canvas-input-dialog-overlay"
      class="absolute inset-0 z-50"
      (pointerdown)="onInputDialogCancel()"
    ></div>
    <div
      id="editor-canvas-input-dialog"
      class="absolute z-50 min-w-64 rounded-sm border border-neutral-200/70 dark:border-neutral-700/60 bg-neutral-50/95 dark:bg-neutral-900/90 backdrop-blur px-4 py-3 shadow-lg"
      [style.left.px]="inputDialogPosition().x"
      [style.top.px]="inputDialogPosition().y"
    >
      <div
        id="editor-canvas-input-dialog-title"
        class="text-xs font-medium text-neutral-700 dark:text-neutral-200 mb-2"
      >
        {{ inputDialogTitle() }}
      </div>
      <div id="editor-canvas-input-dialog-content" class="flex gap-2">
        <input
          #inputField
          id="editor-canvas-input-dialog-field"
          type="number"
          [value]="inputDialogValue()"
          (input)="inputDialogValue.set($any($event.target).value)"
          (keydown.enter)="onInputDialogSubmit()"
          (keydown.escape)="onInputDialogCancel()"
          class="flex-1 text-sm rounded-sm border border-neutral-300 dark:border-neutral-600 px-2 py-1 bg-white dark:bg-neutral-800 text-neutral-800 dark:text-neutral-100"
          min="1"
          max="100"
        />
        <button
          id="editor-canvas-input-dialog-ok"
          type="button"
          class="px-3 py-1 text-xs rounded-sm bg-neutral-200 dark:bg-neutral-700 text-neutral-800 dark:text-neutral-100 hover:bg-neutral-300 dark:hover:bg-neutral-600"
          (click)="onInputDialogSubmit()"
        >
          OK
        </button>
        <button
          id="editor-canvas-input-dialog-cancel"
          type="button"
          class="px-3 py-1 text-xs rounded-sm bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-200 hover:bg-neutral-200 dark:hover:bg-neutral-700"
          (click)="onInputDialogCancel()"
        >
          Cancel
        </button>
      </div>
    </div>
  }

  <pa-pixel-generation-dialog
    (onGenerate)="handleGenerate($event)"
  ></pa-pixel-generation-dialog>

  <pa-fill-selection-dialog></pa-fill-selection-dialog>
</div>
